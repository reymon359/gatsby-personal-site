{"componentChunkName":"component---src-templates-post-tsx","path":"/managing-the-infrastructure-of-a-reusable-ecommerce-platform-with-terraform/","result":{"data":{"site":{"siteMetadata":{"title":"ramonmorcillo.com"}},"markdownRemark":{"id":"a666bd99-85f7-5428-93dc-b837bffb8c85","excerpt":"Setting up and maintaining the infrastructure for a reusable ecommerce platform with a microservice architecture is not an easy task. You have to provide every service with resources, keep track of them and update them when needed. Our team uses Azure as our cloud provider to manage all those resources. Every service uses different resources related to the business logic they handle. We use resources like Azure Service Bus to handle the asynchronous communication between them and Azure Key Vault to store the secrets and environment variables. In the ones where we need a persistence layer, we rely on the resources Azure Cosmos DB or Azure Database for PostgreSQL. Other services provide an API to search among a catalog of products with Azure Cognitive Search. As I will explain later, we work with different environments, therefore, creating and updating the resources across them becomes a harder task. If you want to understand better the context of the reusable ecommerce platform I mention in this lecture, I recommend you to take a look at this article. Although the architecture has changed a bit, the core concept of the reusable ecommerce platform remains the same, making this article easier to understand. So, how do you keep track of all the services resources that are being used across them? This is where Terraform comes in handy. Table of Contents What is Terraform Modules Resources Terraform Plan Terraform Apply State How we use it Version Control System Terraform Variables Environments and CICD Conclusions What is Terraform  Terraform is an open-source infrastructure as code software tool developed by HashiCorp. It provides a consistent CLI workflow to manage hundreds of cloud services in configuration files. Here is the official guide on how to install it. Terraform is a tool that helps you manage various cloud infrastructure services coding configuration files where you can configure the ones needed. It has support for the main cloud providers out there like AWS, Azure, or GCP. I will enumerate the main features it provides. There are plenty more, however, these are the minimum ones required to understand the tool and this article. Modules Terraform provides modules that help us reuse our Terraform code. Our complex infrastructure is broken into multiple modules making it more reusable and simpler to maintain. It is very easy to convert a given Terraform configuration into modules and Terraform has its eco-system for pre-built modules. Resources…","html":"<p>Setting up and maintaining the infrastructure for a <a href=\"https://ramonmorcillo.com/developing-a-reusable-ecommerce-platform/\">reusable ecommerce platform</a> with a microservice architecture is not an easy task. You have to provide every service with resources, keep track of them and update them when needed.</p>\n<p>Our team uses <a href=\"https://azure.microsoft.com/en-us/\">Azure</a> as our cloud provider to manage all those resources. <strong>Every service uses different resources related to the business logic they handle.</strong> We use resources like <a href=\"https://azure.microsoft.com/en-us/services/service-bus/\">Azure Service Bus</a> to handle the asynchronous communication between them and <a href=\"https://azure.microsoft.com/en-us/services/key-vault/\">Azure Key Vault</a> to store the secrets and environment variables.</p>\n<p>In the ones where we need a persistence layer, we rely on the resources <a href=\"https://azure.microsoft.com/en-us/services/cosmos-db/\">Azure Cosmos DB</a> or <a href=\"https://azure.microsoft.com/en-us/services/postgresql/\">Azure Database for PostgreSQL</a>. Other services provide an API to search among a catalog of products with <a href=\"https://azure.microsoft.com/en-us/services/search/\">Azure Cognitive Search</a>. As I will explain later, we work with different <em>environments</em>, therefore, creating and updating the resources across them becomes a harder task.</p>\n<p>If you want to understand better the context of the <strong>reusable ecommerce platform</strong> I mention in this lecture, I recommend you to take a look at <a href=\"https://ramonmorcillo.com/developing-a-reusable-ecommerce-platform/\">this article</a>. Although the architecture has changed a bit, the core concept of the reusable ecommerce platform remains the same, making this article easier to understand.</p>\n<p>So, how do you keep track of all the services resources that are being used across them?</p>\n<p>This is where <a href=\"https://www.terraform.io/\">Terraform</a> comes in handy.</p>\n<h2 id=\"Table-of-Contents\" style=\"position:relative;\">Table of Contents<a href=\"#Table-of-Contents\" aria-label=\"Table of Contents permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li><a href=\"#What-is-Terraform\">What is Terraform</a>\n<ul>\n<li><a href=\"#Modules\">Modules</a></li>\n<li><a href=\"#Resources\">Resources</a></li>\n<li><a href=\"#Terraform-Plan\">Terraform Plan</a></li>\n<li><a href=\"#Terraform-Apply\">Terraform Apply</a></li>\n<li><a href=\"#State\">State</a></li>\n</ul>\n</li>\n<li><a href=\"#How-we-use-it\">How we use it</a>\n<ul>\n<li><a href=\"#Version-Control-System\">Version Control System</a></li>\n<li><a href=\"#Terraform-Variables\">Terraform Variables</a></li>\n<li><a href=\"#Environments-and-CICD\">Environments and CICD</a></li>\n</ul>\n</li>\n<li><a href=\"#Conclusions\">Conclusions</a></li>\n</ul>\n<h2 id=\"What-is-Terraform\" style=\"position:relative;\">What is Terraform<a href=\"#What-is-Terraform\" aria-label=\"What is Terraform permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"border-bottom: none;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-personal-site/static/a6a61ede589d9e27f003a629c30bbe80/29114/hashicorp_terraform_logo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxklEQVQoz6VSMQuCQBj1nxu0lEs2HNjmLBpSo066BNKiTUU2SFvUBR0RfN93kRdyQg3qm747eO/ee98ZcgCMZiKShFI7UgeyArb5iKhUAKCZ2+T6ht/geHjVfKqqqixPQgglAQB/X1Zydw6LGZ+M98WOr1dL0xxFUZQkCWPM9/04jj3Py7Lsh23ldrt5zqdnKWWeF5ZlhWHouq5t20EQMMYcx0nTFLVgrczigdcLNF46F0YffHOqhlDDr8L0bVGvPQ/6JD3Ib1XSebaKWxI5AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Terraform logo by HashiCorp\"\n        title=\"Terraform logo by HashiCorp\"\n        src=\"/gatsby-personal-site/static/a6a61ede589d9e27f003a629c30bbe80/0a47e/hashicorp_terraform_logo.png\"\n        srcset=\"/gatsby-personal-site/static/a6a61ede589d9e27f003a629c30bbe80/8a4e8/hashicorp_terraform_logo.png 150w,\n/gatsby-personal-site/static/a6a61ede589d9e27f003a629c30bbe80/5a46d/hashicorp_terraform_logo.png 300w,\n/gatsby-personal-site/static/a6a61ede589d9e27f003a629c30bbe80/0a47e/hashicorp_terraform_logo.png 600w,\n/gatsby-personal-site/static/a6a61ede589d9e27f003a629c30bbe80/1cfc2/hashicorp_terraform_logo.png 900w,\n/gatsby-personal-site/static/a6a61ede589d9e27f003a629c30bbe80/c1b63/hashicorp_terraform_logo.png 1200w,\n/gatsby-personal-site/static/a6a61ede589d9e27f003a629c30bbe80/29114/hashicorp_terraform_logo.png 1920w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>Terraform logo by HashiCorp</p></figcaption>\n  </figure></p>\n<p><a href=\"https://www.terraform.io/\">Terraform</a> is an open-source infrastructure as code software tool developed by HashiCorp. It provides a consistent CLI workflow to manage hundreds of cloud services in configuration files. <a href=\"https://learn.hashicorp.com/tutorials/terraform/install-cli\">Here</a> is the official guide on how to install it.</p>\n<p>Terraform is a tool that helps you manage various cloud infrastructure services coding configuration files where you can configure the ones needed. It has support for the main cloud providers out there like AWS, Azure, or GCP.</p>\n<p>I will enumerate the main features it provides. There are plenty more, however, these are the minimum ones required to understand the tool and this article.</p>\n<h3 id=\"Modules\" style=\"position:relative;\">Modules<a href=\"#Modules\" aria-label=\"Modules permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Terraform provides modules that help us <strong>reuse our Terraform code.</strong> Our complex infrastructure is broken into multiple modules making it more reusable and simpler to maintain.</p>\n<p>It is very easy to convert a given Terraform configuration into modules and Terraform has its eco-system for pre-built modules.</p>\n<h3 id=\"Resources\" style=\"position:relative;\">Resources<a href=\"#Resources\" aria-label=\"Resources permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Resources are the <em>key</em> element in Terraform. Each of them describes a cloud service such as a computed instance, persistence system, or DNS record.</p>\n<p>Here is a simple example of how we would define a resource we want to use in our infrastructure:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">terraform</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">required_providers</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">food</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">source</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"hashicorp/food\"</span>\n      <span class=\"token property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"~> 1.0.4\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"food_tapas\"</span></span> <span class=\"token string\">\"spanish_omelet\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">ingredient_1</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"eggs\"</span>\n  <span class=\"token property\">ingredient_2</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"onions\"</span>\n  <span class=\"token property\">Ingredient_3</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"potatoes\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The language used in Terraform is the <em>HashiCorp Configuration Language (HCL)</em>. In the example above we first specify the cloud provider <code class=\"language-text\">food</code>. Then define a resource of the type <code class=\"language-text\">food_tapas</code> with the name <code class=\"language-text\">spanish_omelet</code>. Inside the resource block, we have the configuration arguments which are the ingredients for this delicious resource.</p>\n<h3 id=\"Terraform-Plan\" style=\"position:relative;\">Terraform Plan<a href=\"#Terraform-Plan\" aria-label=\"Terraform Plan permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Once all the infrastructure resources have been defined, a <strong>Plan</strong> is run. Here Terraform checks the code for syntax errors, state verification, API authentication, and then outputs a summary of the changes.</p>\n<p>Running <code class=\"language-text\">terraform plan</code> allows you to check if the plan to be applied for such configuration is the one you were expecting before changing the infrastructure.</p>\n<p>Here is an example of the output summary we would get when running <code class=\"language-text\">terraform plan</code> with the example resource</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ terraform plan\nAn execution plan has been generated and is shown below.\n\nResource actions are indicated with the following symbols:\n  + create\n\nTerraform will perform the following actions:\n\n  <span class=\"token comment\"># food_tapas.spanish_omelet will be created</span>\n  + resource <span class=\"token string\">\"food_tapas\"</span> <span class=\"token string\">\"spanish_omelet\"</span> <span class=\"token punctuation\">{</span>\n        + <span class=\"token function\">id</span>                <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>known after apply<span class=\"token punctuation\">)</span>\n        + ingredient_1      <span class=\"token operator\">=</span> <span class=\"token string\">\"eggs\"</span>\n        + ingredient_2      <span class=\"token operator\">=</span> <span class=\"token string\">\"onions\"</span>\n        + ingredient_3      <span class=\"token operator\">=</span> <span class=\"token string\">\"potatoes\"</span>\n    <span class=\"token punctuation\">}</span>\n\nPlan: <span class=\"token number\">1</span> to add, <span class=\"token number\">0</span> to change, <span class=\"token number\">0</span> to destroy.</code></pre></div>\n<h3 id=\"Terraform-Apply\" style=\"position:relative;\">Terraform Apply<a href=\"#Terraform-Apply\" aria-label=\"Terraform Apply permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Once confirmed, the summary of changes are the ones wanted, we execute them with <code class=\"language-text\">terraform apply</code>.</p>\n<p>After running it successfully the console shows this output.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"> Apply complete<span class=\"token operator\">!</span> Resources: <span class=\"token number\">1</span> added, <span class=\"token number\">0</span> changed, <span class=\"token number\">0</span> destroyed.</code></pre></div>\n<p>And that is an overall view of defining and creating your infrastructure resources in an <em>automated</em> way. All through config files <strong>removing the manual process.</strong></p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"border-bottom: none;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-personal-site/static/37e8e5bd5e711982952ed71563235c71/a2510/terraform_resource_spanish_omelet_from_casa_paco_madrid.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAQFA//EABYBAQEBAAAAAAAAAAAAAAAAAAIAAf/aAAwDAQACEAMQAAABSal0huRPFf/EABoQAAMAAwEAAAAAAAAAAAAAAAECAwAREiL/2gAIAQEAAQUCii9MEoUWQHRGV8w2c//EABURAQEAAAAAAAAAAAAAAAAAABEQ/9oACAEDAQE/AUn/xAAXEQADAQAAAAAAAAAAAAAAAAAAAREh/9oACAECAQE/AY2af//EABsQAAIDAAMAAAAAAAAAAAAAAAERAAIhEFGx/9oACAEBAAY/AmSche+xWqzAXBYZbvj/xAAaEAEAAgMBAAAAAAAAAAAAAAABABEhMVFB/9oACAEBAAE/Iacjjs3AViHtJUWLgVzzc0IEYZ//2gAMAwEAAgADAAAAEB/P/8QAFhEAAwAAAAAAAAAAAAAAAAAAAAER/9oACAEDAQE/EIQiP//EABYRAQEBAAAAAAAAAAAAAAAAABEAAf/aAAgBAgEBPxDdizP/xAAaEAEBAAMBAQAAAAAAAAAAAAABEQAhQTHh/9oACAEBAAE/EIgm7EVyTnuRJsDdQd+ZchYKVGYU+Qjc7WB0EvswkKXfuf/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Terraform resource Spanish omelet from Casa Paco, Madrid\"\n        title=\"Terraform resource Spanish omelet from Casa Paco, Madrid\"\n        src=\"/gatsby-personal-site/static/37e8e5bd5e711982952ed71563235c71/b4294/terraform_resource_spanish_omelet_from_casa_paco_madrid.jpg\"\n        srcset=\"/gatsby-personal-site/static/37e8e5bd5e711982952ed71563235c71/75985/terraform_resource_spanish_omelet_from_casa_paco_madrid.jpg 150w,\n/gatsby-personal-site/static/37e8e5bd5e711982952ed71563235c71/f93b5/terraform_resource_spanish_omelet_from_casa_paco_madrid.jpg 300w,\n/gatsby-personal-site/static/37e8e5bd5e711982952ed71563235c71/b4294/terraform_resource_spanish_omelet_from_casa_paco_madrid.jpg 600w,\n/gatsby-personal-site/static/37e8e5bd5e711982952ed71563235c71/8e1fc/terraform_resource_spanish_omelet_from_casa_paco_madrid.jpg 900w,\n/gatsby-personal-site/static/37e8e5bd5e711982952ed71563235c71/a2510/terraform_resource_spanish_omelet_from_casa_paco_madrid.jpg 1000w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>Terraform resource Spanish omelet from Casa Paco, Madrid</p></figcaption>\n  </figure></p>\n<h3 id=\"State\" style=\"position:relative;\">State<a href=\"#State\" aria-label=\"State permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>The last thing to mention would be the <strong>Terraform State.</strong> Its purpose is to store the relation between the objects in a remote system and the resource instances declared in your configuration.</p>\n<p>When the remote object is created its identity is recorded against a particular resource instance.</p>\n<p>Future configuration changes will update the state and make terraform update or delete that object.</p>\n<h2 id=\"How-we-use-it\" style=\"position:relative;\">How we use it<a href=\"#How-we-use-it\" aria-label=\"How we use it permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Going back to our reusable ecommerce platform. Here is how we take advantage of Terraform’s features to improve our workflow.</p>\n<h3 id=\"Version-Control-System\" style=\"position:relative;\">Version Control System<a href=\"#Version-Control-System\" aria-label=\"Version Control System permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Having all the infrastructure defined in code files means we can use a <strong>VCS</strong> (Version Control System). We opt for Git and host it in a GitHub repository. This way we can keep a history control of the resources we have been using.</p>\n<p>In addition, the integration with GitHub allows us to work with pull requests in order to add, change or destroy resources from the Infrastructure.</p>\n<p>Although the Terraform State is stored locally by default in a file named <code class=\"language-text\">terraform.tfstate</code>, we store it remotely outside the VCS. This is a good practice when working in a team environment.</p>\n<h3 id=\"Terraform-Variables\" style=\"position:relative;\">Terraform Variables<a href=\"#Terraform-Variables\" aria-label=\"Terraform Variables permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Being a reusable platform means its infrastructure has to be the same in every shop we create. With terraform, we accomplish this by defining a <a href=\"https://www.terraform.io/docs/language/values/variables.html\">Terraform input variable</a> called <code class=\"language-text\">shops_to_apply</code>.</p>\n<p>We then pass this variable through the modules and resources where we want to use it.  This way when we apply the plan the changes will happen in each of the shops.</p>\n<p>Here is an example of how we would define the variable if we had to set up the infrastructure for three different shops.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"shops_to_apply\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token property\">happy</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"happyReadings\"</span>\n   <span class=\"token property\">world</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"worldOfWaves\"</span>   \n   <span class=\"token property\">healt</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"healthyFruits\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then in each resource, we use a Terraform <a href=\"https://www.terraform.io/docs/language/meta-arguments/for_each.html\">for_each meta-argument</a> to iterate them.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"azurerm_postgresql_database\"</span></span> <span class=\"token string\">\"orders-api-service\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">for_each</span>            <span class=\"token punctuation\">=</span> var.shops_to_apply\n  <span class=\"token property\">name</span>                <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>each<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">}</span></span>-orders-api-service\"</span>\n  ... other config\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"Environments-and-CICD\" style=\"position:relative;\">Environments and CICD<a href=\"#Environments-and-CICD\" aria-label=\"Environments and CICD permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>We work with three environments:</p>\n<ul>\n<li><strong>Development:</strong> A testing environment where all services new features, refactors, and bug fixes get released once merged to the main repository branch.</li>\n<li><strong>Staging:</strong> A mirror of the Production environment. When the changes have been properly implemented in Development they are promoted to this environment. In this environment, we can see how they will work in a production-similar situation.</li>\n<li><strong>Production:</strong> The environment the user has access to. The final environment where the changes get promoted from Staging.</li>\n</ul>\n<p>Not all the changes are visible at once in each environment. We use <a href=\"https://configcat.com/\">ConfigCat</a> as our system of feature flags to make most of the changes visible or not.</p>\n<p>We use <a href=\"https://github.com/features/actions\">GitHub Actions</a> and <a href=\"https://azure.microsoft.com/en-us/services/devops/pipelines/\">Azure DevOps</a> for our Continuous Integration and Continuous Delivery system. When the changes on the Terraform infrastructure repository are added to the main branch, the CICD system gets triggered and the plan is executed on our development environments. When the logs from the plan are the expected ones we manually run the <code class=\"language-text\">apply</code>.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"border-bottom: none;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-personal-site/static/440d108f6f09e565d0cf7750ac4557cb/c352c/azure_devops_release_pipelines.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAByIpAf//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABYQAAMAAAAAAAAAAAAAAAAAAAAggf/aAAgBAQABPyEq/wD/2gAMAwEAAgADAAAAEMAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxAAAgIDAQAAAAAAAAAAAAAAAREAIRAxcaH/2gAIAQEAAT8QaVpw2bDuAb3He/Mf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Azure DevOps Release Stages\"\n        title=\"Azure DevOps Release Stages\"\n        src=\"/gatsby-personal-site/static/440d108f6f09e565d0cf7750ac4557cb/b4294/azure_devops_release_pipelines.jpg\"\n        srcset=\"/gatsby-personal-site/static/440d108f6f09e565d0cf7750ac4557cb/75985/azure_devops_release_pipelines.jpg 150w,\n/gatsby-personal-site/static/440d108f6f09e565d0cf7750ac4557cb/f93b5/azure_devops_release_pipelines.jpg 300w,\n/gatsby-personal-site/static/440d108f6f09e565d0cf7750ac4557cb/b4294/azure_devops_release_pipelines.jpg 600w,\n/gatsby-personal-site/static/440d108f6f09e565d0cf7750ac4557cb/8e1fc/azure_devops_release_pipelines.jpg 900w,\n/gatsby-personal-site/static/440d108f6f09e565d0cf7750ac4557cb/e5166/azure_devops_release_pipelines.jpg 1200w,\n/gatsby-personal-site/static/440d108f6f09e565d0cf7750ac4557cb/c352c/azure_devops_release_pipelines.jpg 1464w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>Azure DevOps Release Stages</p></figcaption>\n  </figure></p>\n<h2 id=\"Conclusions\" style=\"position:relative;\">Conclusions<a href=\"#Conclusions\" aria-label=\"Conclusions permalink\" class=\"autolink-headers after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\" style=\"margin: 0 0 -0.2rem 0.7rem; \"><path fill=\"white\" fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Having the infrastructure defined as code has brought us nothing but improvements to our platform. Here is a list of them:</p>\n<ul>\n<li><strong>Reduce human error and increase automation.</strong> The fewer resources you set up manually, the fewer errors you get in the long term.</li>\n<li><strong>It is easier to maintain</strong> since all the infrastructure is coded in config files. Plus we are <strong>using GitHub repositories and Pull Requests</strong> to collaborate all together.</li>\n<li>The infrastructure is <strong>easier to change</strong> compared to traditional manual ways.</li>\n<li>All the configuration files work as <strong>documentation of the resources</strong> we are using.</li>\n<li>Thanks to the use of variables we <strong>speed up the process of setting up new ecommerce platforms.</strong></li>\n<li>Updating and deleting resources is a delicate topic. Having a proper CICD allows us to <strong>predict and make changes to the infrastructure in the safest way possible.</strong></li>\n<li>We can effortlessly <strong>provision our development, staging, and production environments with the same consistent configuration.</strong></li>\n</ul>","frontmatter":{"title":"Managing the infrastructure of a reusable ecommerce platform with Terraform","description":"Advice to manage the infrastructure of an ecommerce platform in Azure with Terraform.","date":"June 03, 2021","tags":["Software Development","Azure","DevOps","Ecommerce","Terraform"],"commentsUrl":"https://github.com/reymon359/gatsby-personal-site/issues/534","featuredImage":{"childImageSharp":{"fixed":{"src":"/gatsby-personal-site/static/2feffc83f5783abceeb974b23390af50/2244e/denys-nevozhai-Zeu57mprpaI-unsplash.jpg"},"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAQX/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/2gAMAwEAAhADEAAAAYLuVhTxBt//xAAZEAADAQEBAAAAAAAAAAAAAAABAhEAEiH/2gAIAQEAAQUCS7oqCxt8Da7/xAAXEQEBAQEAAAAAAAAAAAAAAAABAAIS/9oACAEDAQE/ATSXTf/EABcRAQEBAQAAAAAAAAAAAAAAAAEAAhH/2gAIAQIBAT8BcjcL/8QAGhAAAgIDAAAAAAAAAAAAAAAAAAEQMSEygf/aAAgBAQAGPwK2bPhbjEf/xAAbEAACAwADAAAAAAAAAAAAAAAAEQExQYGRsf/aAAgBAQABPyGTeBNqC+YNroTqORz/2gAMAwEAAgADAAAAEEsP/8QAFhEBAQEAAAAAAAAAAAAAAAAAADFh/9oACAEDAQE/EIDR/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAExYf/aAAgBAgEBPxCwhk//xAAdEAEBAQABBQEAAAAAAAAAAAABEQBRITFBYXGR/9oACAEBAAE/EGkReaf3LeQNLOnlz2k9K4OBA9xS5bj4ao2peHf/2Q==","aspectRatio":1.5037593984962405,"src":"/gatsby-personal-site/static/2feffc83f5783abceeb974b23390af50/14b42/denys-nevozhai-Zeu57mprpaI-unsplash.jpg","srcSet":"/gatsby-personal-site/static/2feffc83f5783abceeb974b23390af50/f836f/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 200w,\n/gatsby-personal-site/static/2feffc83f5783abceeb974b23390af50/2244e/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 400w,\n/gatsby-personal-site/static/2feffc83f5783abceeb974b23390af50/14b42/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 800w,\n/gatsby-personal-site/static/2feffc83f5783abceeb974b23390af50/47498/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 1200w,\n/gatsby-personal-site/static/2feffc83f5783abceeb974b23390af50/0e329/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 1600w,\n/gatsby-personal-site/static/2feffc83f5783abceeb974b23390af50/d8255/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 1920w","sizes":"(max-width: 800px) 100vw, 800px"}}}}}},"pageContext":{"slug":"/managing-the-infrastructure-of-a-reusable-ecommerce-platform-with-terraform/","previous":{"fields":{"slug":"/traveling-through-the-canary-islands-an-in-depth-guide-to-the-canary-islands/"},"frontmatter":{"tags":["Adventures","Trips","Canary Islands","Guide"],"title":"Traveling through The Canary Islands: An in-depth guide to the Canary Islands","type":"post"}},"next":null}},"staticQueryHashes":["1500402284","474397040"]}